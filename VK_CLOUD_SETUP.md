# Настройка VK Cloud для DosMundosPodcast

## Обзор

Проект был обновлен для поддержки VK Cloud S3-совместимого хранилища в дополнение к Cloudflare R2. Теперь можно использовать VK Cloud для хранения аудиофайлов.

## Структура изменений

### Новые файлы:
- `src/lib/vkCloudService.js` - сервис для работы с VK Cloud
- `src/lib/storageService.js` - универсальный сервис для работы с хранилищем
- `VK_CLOUD_SETUP.md` - данная документация

### Обновленные файлы:
- Все компоненты загрузки файлов теперь используют `storageService` вместо `r2Service`
- Добавлены новые локализованные строки для VK Cloud
- Обновлены хуки и страницы управления

## Настройка VK Cloud

### 1. Создание бакета в VK Cloud

1. Войдите в панель управления VK Cloud
2. Перейдите в раздел "Объектное хранилище"
3. Создайте новый бакет с именем, например, `dosmundos-audio`
4. Настройте публичный доступ к файлам (если необходимо)

### 2. Получение ключей доступа

1. В панели управления VK Cloud перейдите в раздел "API ключи"
2. Создайте новый API ключ
3. Запишите:
   - Access Key ID
   - Secret Access Key

### 3. Настройка переменных окружения в Supabase

В Supabase Edge Function `get-env-variables` добавьте следующие переменные окружения:

```bash
VK_ACCESS_KEY_ID=your_access_key_id
VK_SECRET_KEY=your_secret_key
VK_BUCKET_NAME=dosmundos-audio
VK_ENDPOINT=https://hb.bizmrg.com
VK_REGION=ru-msk
```

### 4. Конфигурация хранилища

В файле `src/lib/storageService.js` можно изменить настройки:

```javascript
// Изменить на 'r2' для использования Cloudflare R2
const DEFAULT_STORAGE = 'vkCloud'; // 'r2' или 'vkCloud'
```

## Использование

### Автоматическое переключение

Система автоматически:
1. Пытается использовать VK Cloud (если установлен как DEFAULT_STORAGE)
2. При ошибке переключается на R2
3. Определяет тип хранилища по имени бакета при удалении файлов

### Ручное переключение

Для переключения между хранилищами измените константу `DEFAULT_STORAGE` в `storageService.js`:

```javascript
const DEFAULT_STORAGE = 'r2'; // Использовать R2
// или
const DEFAULT_STORAGE = 'vkCloud'; // Использовать VK Cloud
```

## Особенности VK Cloud

### Endpoint
VK Cloud использует endpoint: `https://hb.bizmrg.com`

### Регион
По умолчанию используется регион `ru-msk`

### Path-style URLs
VK Cloud требует path-style URLs, поэтому используется `forcePathStyle: true`

### Публичные URL
Файлы доступны по URL вида: `https://hb.bizmrg.com/bucket-name/file-key`

## Миграция данных

### Существующие файлы в R2
- Файлы, уже загруженные в R2, продолжат работать
- При удалении система автоматически определит правильное хранилище
- Новые файлы будут загружаться в VK Cloud

### База данных
- Поля `r2_object_key` и `r2_bucket_name` остаются без изменений
- Для VK Cloud используются те же поля (для совместимости)

## Устранение неполадок

### Ошибки подключения к VK Cloud
1. Проверьте правильность API ключей
2. Убедитесь, что бакет существует и доступен
3. Проверьте настройки CORS в VK Cloud

### Fallback на R2
Если VK Cloud недоступен, система автоматически переключится на R2. Проверьте логи консоли для диагностики.

### Проблемы с доступом к файлам
1. Убедитесь, что бакет настроен для публичного доступа
2. Проверьте правильность endpoint URL
3. Убедитесь, что регион указан корректно

## Безопасность

- API ключи хранятся в Supabase Edge Function
- Не храните ключи в клиентском коде
- Используйте минимальные права доступа для API ключей
- Регулярно ротируйте API ключи

## Поддержка

При возникновении проблем:
1. Проверьте логи браузера
2. Убедитесь в правильности настроек VK Cloud
3. Проверьте доступность Supabase Edge Function
4. Убедитесь в корректности переменных окружения 