# Руководство по тестированию кэша и офлайн режима

## Что было улучшено

### 1. Компонент CacheSettings
- ✅ Добавлено отображение общего хранилища браузера (quota/usage)
- ✅ Детальная статистика: аудиофайлы и кешированные данные отдельно
- ✅ Список всех кешированных файлов с информацией:
  - Название эпизода
  - Размер файла
  - Время последнего доступа
  - Возможность удалить отдельный файл
- ✅ Улучшенный UI с раскрывающимся списком файлов
- ✅ Кнопка обновления статистики
- ✅ Визуализация использования хранилища

### 2. Сервис audioCacheService
- ✅ Метод getCacheStats() возвращает полную информацию о файлах
- ✅ Управление размером кэша с автоматическим удалением старых файлов
- ✅ Отслеживание времени последнего доступа
- ✅ Поддержка прогресса загрузки

### 3. Офлайн режим
- ✅ Service Worker кэширует аудиофайлы
- ✅ IndexedDB хранит метаданные
- ✅ Синхронизация при восстановлении соединения
- ✅ Индикатор офлайн статуса

## Как протестировать

### 1. Проверка кэша аудиофайлов

1. Откройте приложение: http://localhost:5174/
2. В правом верхнем углу найдите кнопку с иконкой Settings (⚙️)
3. Кликните на неё - откроется панель с настройками кэша
4. Проверьте отображаемую информацию:
   - Общее хранилище браузера
   - Использование кэша
   - Количество файлов

### 2. Кэширование эпизода

1. Откройте любой эпизод
2. Нажмите на кнопку "Сохранить" (или download icon)
3. Наблюдайте прогресс загрузки
4. После завершения файл появится в списке кэшированных
5. Откройте настройки кэша и нажмите "Файлы (X)" чтобы увидеть список
6. Проверьте информацию о файле:
   - Название эпизода
   - Размер
   - Время кэширования

### 3. Управление файлами

1. В списке файлов найдите кнопку удаления (корзина) рядом с каждым файлом
2. Нажмите на неё чтобы удалить отдельный файл
3. Используйте "Очистить кэш" чтобы удалить все файлы сразу
4. Проверьте обновление статистики после удаления

### 4. Тест офлайн режима

1. Откройте DevTools (F12)
2. Перейдите на вкладку Network
3. Включите офлайн режим (Offline checkbox)
4. Попробуйте воспроизвести кэшированный эпизод
5. Проверьте что аудио воспроизводится из кэша
6. Индикатор в верхнем правом углу должен показать "Offline mode"

### 5. Проверка автоочистки

1. Установите малый размер кэша (например, 0.5 GB)
2. Загрузите несколько больших эпизодов
3. При превышении лимита старые файлы должны автоматически удаляться
4. Проверьте что удаляются самые давно использованные файлы

## Проверка Service Worker

Откройте DevTools → Application → Service Workers
Проверьте:
- Service Worker зарегистрирован и активен
- Версия: audio-v1
- Статус: Activated and running

Откройте DevTools → Application → Cache Storage
Проверьте:
- Кэш "audio-v1" содержит загруженные аудиофайлы
- Размеры файлов соответствуют ожидаемым

## Проверка IndexedDB

Откройте DevTools → Application → IndexedDB → PodcastAppDB
Проверьте таблицы:
- episodes: кэшированные эпизоды
- transcripts: кэшированные транскрипты
- questions: кэшированные вопросы
- audioFiles: метаданные аудиофайлов
  - url
  - episode_slug
  - size
  - cached_at
  - last_accessed

## Известные проблемы и решения

### Проблема: Файлы не кэшируются
Решение:
1. Проверьте что Service Worker зарегистрирован
2. Убедитесь что браузер поддерживает Cache API
3. Проверьте доступное место на диске
4. Очистите кэш и попробуйте снова

### Проблема: Статистика не обновляется
Решение:
1. Нажмите кнопку "Обновить"
2. Проверьте консоль на ошибки
3. Перезагрузите страницу

### Проблема: Офлайн режим не работает
Решение:
1. Убедитесь что файл был полностью закэширован
2. Проверьте Service Worker в DevTools
3. Очистите кэш и закэшируйте файл заново

## Структура кода

### Основные файлы:
- `src/components/CacheSettings.jsx` - UI компонент настроек кэша
- `src/lib/audioCacheService.js` - сервис управления аудио кэшем
- `src/lib/offlineDataService.js` - работа с IndexedDB
- `public/sw.js` - Service Worker

### Ключевые функции:
- `audioCacheService.cacheAudio()` - кэширование аудио
- `audioCacheService.getCacheStats()` - статистика кэша
- `audioCacheService.removeAudioFromCache()` - удаление из кэша
- `audioCacheService.clearCache()` - очистка всего кэша

## Рекомендации

1. **Размер кэша**: Устанавливайте размер кэша в зависимости от устройства
   - Мобильные: 0.5-1 GB
   - Desktop: 2-5 GB

2. **Автоочистка**: Включайте автоматическую очистку старых файлов

3. **Мониторинг**: Регулярно проверяйте использование хранилища

4. **Пользовательский опыт**: 
   - Показывайте прогресс загрузки
   - Предупреждайте о нехватке места
   - Позволяйте управлять отдельными файлами

## Следующие шаги

- [ ] Добавить фоновую синхронизацию при восстановлении соединения
- [ ] Реализовать приоритизацию кэширования
- [ ] Добавить экспорт/импорт кэша
- [ ] Реализовать сжатие аудиофайлов
- [ ] Добавить статистику использования по эпизодам
