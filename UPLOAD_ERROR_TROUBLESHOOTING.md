# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

## –û—à–∏–±–∫–∞: `net::ERR_HTTP2_PROTOCOL_ERROR`

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ R2 (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ) –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:
```
PUT https://dosmundos-audio.s3.kz-1.srvstorage.kz/... net::ERR_HTTP2_PROTOCOL_ERROR
TypeError: Failed to fetch
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ S3 endpoint –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å HTTP/2 –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º.

### üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

S3 endpoint –Ω–∞ `srvstorage.kz` –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π HTTP/2:
- –°–µ—Ä–≤–µ—Ä –æ–±—ä—è–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É HTTP/2 (h2) –≤ ALPN
- –ù–æ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å PUT –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ HTTP/2
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ HTTP/1.1 –æ—à–∏–±–∫–∞ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è
- –≠—Ç–æ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –ü–û

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### 1. **HTTP/1.1 Retry (–û—Å–Ω–æ–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)**

```javascript
// –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ - XHR –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
await innerAttemptUpload(0, maxRetries, false);

// –ï—Å–ª–∏ HTTP/2 –æ—à–∏–±–∫–∞:
if (isHttp2Error && !forceHttp1) {
  return innerAttemptUpload(0, maxRetries, true);  // Retry —Å forceHttp1=true
}

// –ü—Ä–∏ forceHttp1 = true –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:
xhr.setRequestHeader('Upgrade-Insecure-Requests', '1');
```

#### 2. **Chunked Upload –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤**

–î–ª—è —Ñ–∞–π–ª–æ–≤ > 50MB –ø—Ä–∏ HTTP/2 –æ—à–∏–±–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞–∑–¥—Ä–æ–±–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:
- –†–∞–∑–¥–µ–ª—è–µ—Ç —Ñ–∞–π–ª –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 5MB
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º PUT –∑–∞–ø—Ä–æ—Å–æ–º
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ

```javascript
if (forceHttp1 && totalBytes > 50 * 1024 * 1024) {
  return await attemptChunkedUpload(presignedUrl, file, onProgress);
}
```

#### 3. **–£–¥–∞–ª–µ–Ω—ã –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏**

–ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Connection`, –ø–æ—ç—Ç–æ–º—É –æ–Ω —É–¥–∞–ª–µ–Ω:
```javascript
// ‚ùå –ù–ï–í–ï–†–ù–û - –±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç —ç—Ç–æ
xhr.setRequestHeader('Connection', 'keep-alive');

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
xhr.setRequestHeader('Upgrade-Insecure-Requests', '1');
```

### üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã —É–≤–∏–¥–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ (DevTools ‚Üí Console):

```
[Upload] 2024-09-04_RU.mp3: Attempt 1/4, File size: 25.50MB, ForceHTTP/1.1: false
[Upload] 2024-09-04_RU.mp3: XHR failed - Network error during PUT
[Upload] 2024-09-04_RU.mp3: Detected HTTP/2 issue, retrying with HTTP/1.1 approach...
[Upload] 2024-09-04_RU.mp3: Retrying with forced HTTP/1.1...
[Upload] 2024-09-04_RU.mp3: Attempt 1/4, File size: 25.50MB, ForceHTTP/1.1: true
[Upload] 2024-09-04_RU.mp3: XHR upload succeeded ‚úÖ
```

### üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –∫–æ–¥–µ

- ‚úÖ **Timeout**: 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫) –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ **Progress reporting**: Real-time –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- ‚úÖ **Exponential backoff**: –£–º–Ω—ã–π retry —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–º—Å—è –æ–∂–∏–¥–∞–Ω–∏–µ–º (1s, 2s, 4s)
- ‚úÖ **Detailed logging**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
- ‚úÖ **Smart HTTP/2 detection**: –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è

### ‚ö†Ô∏è –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab –≤ DevTools:**
   - F12 ‚Üí Network ‚Üí –§–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ "2024-09-04_RU.mp3"
   - –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ Response Headers:
     - `alt-svc: h2=":443"; ma=2592000` - –æ–∑–Ω–∞—á–∞–µ—Ç HTTP/2
     - –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫–æ–π Protocol –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è

2. **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:**
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —Ñ–∞–π–ª (~1MB)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ—à–µ–ª –ª–∏ –¥–æ Chunked upload?

3. **–ë—Ä–∞—É–∑–µ—Ä –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Firefox –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
   - –û—Ç–∫–ª—é—á–∏—Ç–µ VPN –∏–ª–∏ –ø—Ä–æ–∫—Å–∏
   - –û—Ç–∫—Ä–æ–π—Ç–µ DevTools –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π)

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–≤:**
   - –ò—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è `[Upload]` –≤ console.log
   - –ò—â–∏—Ç–µ `ERR_HTTP2_PROTOCOL_ERROR` - —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ—è–≤–ª—è–µ—Ç—Å—è?

### üîß –†–µ—à–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)

–ï—Å–ª–∏ –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ S3 endpoint –Ω–∞ `srvstorage.kz`:

1. **–û—Ç–∫–ª—é—á–∏—Ç—å HTTP/2 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
   ```nginx
   # –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx/Apache
   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ HTTP/1.1
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SSL/TLS:**
   ```
   - ALPN protocols –¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ h1 (HTTP/1.1)
   - –ù–µ –æ–±—ä—è–≤–ª—è—Ç—å h2 –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall –ø—Ä–∞–≤–∏–ª–∞:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PUT –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä—ã –ø–∞–∫–µ—Ç–æ–≤

4. **–û–±–Ω–æ–≤–∏—Ç—å –ü–û —Å–µ—Ä–≤–µ—Ä–∞:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é Nginx/Apache/S3 –ü–û
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –±–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

### üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ persists, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É srvstorage.kz:
- –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É: "HTTP/2 Protocol Error –ø—Ä–∏ PUT –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ audio.s3.kz-1.srvstorage.kz"
- –ü—Ä–∏–ª–æ–∂–∏—Ç–µ –ª–æ–≥–∏ (–∏–∑ DevTools Network tab)
- –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ HTTP/2 –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### üöÄ –ö—Ä–∞—Ç–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

| –°–∏—Ç—É–∞—Ü–∏—è | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| –ú–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–∞–π–ª—ã (~1-10MB) | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å HTTP/1.1 –¥–æ–ª–∂–µ–Ω –ø–æ–º–æ—á—å |
| –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>50MB) | –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Chunked upload –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ | –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É srvstorage.kz –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π S3 –ø—Ä–æ–≤–∞–π–¥–µ—Ä |
| VPN/–ü—Ä–æ–∫—Å–∏ | –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –±–µ–∑ –Ω–∏—Ö |
